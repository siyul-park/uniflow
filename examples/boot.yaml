- kind: http
  name: http
  namespace: system
  address: :8000
  links:
    io:
      - name: router
        port: in

- kind: router
  name: router
  namespace: system
  routes:
    - method: POST
      path: /v1/nodes
      port: out[0]
    - method: GET
      path: /v1/nodes
      port: out[1]
    - method: GET
      path: /v1/nodes/:node_id
      port: out[2]
    - method: PATCH
      path: /v1/nodes/:node_id
      port: out[3]
    - method: DELETE
      path: /v1/nodes/:node_id
      port: out[4]
  links:
    out[0]:
      - name: post_nodes
        port: in
    out[1]:
      - name: get_nodes
        port: in
    out[2]:
      - name: get_node
        port: in
    out[3]:
      - name: patch_node
        port: in
    out[4]:
      - name: delete_node
        port: in

- kind: snippet
  name: post_nodes
  namespace: system
  lang: jsonata
  code: |
    $.body
  links:
    out:
      - name: insert
        port: io

- kind: snippet
  name: get_nodes
  namespace: system
  lang: json
  code: |
    null
  links:
    out:
      - name: select
        port: io

- kind: snippet
  name: get_node
  namespace: system
  lang: jsonata
  code: |
    { "id": $.params.node_id }
  links:
    out:
      - name: select
        port: io

- kind: snippet
  name: patch_node
  namespace: system
  lang: jsonata
  code: |
    $merge([{ "id": $.params.node_id }, $.body])
  links:
    out:
      - name: update
        port: io

- kind: snippet
  name: delete_node
  namespace: system
  lang: jsonata
  code: |
    { "id": $.params.node_id }
  links:
    out:
      - name: delete
        port: io

- kind: reflect
  name: insert
  namespace: system
  op: insert
  links:
    error:
      - name: not_found
        port: io

- kind: reflect
  name: select
  namespace: system
  op: select
  links:
    error:
      - name: not_found
        port: io

- kind: reflect
  name: update
  namespace: system
  op: update
  links:
    error:
      - name: not_found
        port: io

- kind: reflect
  name: delete
  namespace: system
  op: delete
  links:
    error:
      - name: not_found
        port: io

- kind: snippet
  name: not_found
  namespace: system
  lang: json
  code: |
    { 
      "body": "Not Found",
      "status": 404
    }
