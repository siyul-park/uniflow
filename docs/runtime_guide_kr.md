# 워크플로우 초기화 및 실행 과정

워크플로우는 방향성 그래프로 표현되며, 노드 간 데이터 흐름을 통해 작업을 처리합니다. 본 문서는 워크플로우가 초기화되고 실행되는 전체 과정을 상세히 설명합니다. 핵심 구성 요소로는 런타임, 로더, 심볼 테이블, 훅, 프로세스, 포트가 있습니다.

## 초기화 단계
```
┌─────────────────────┐
│      런타임 초기화     │
│  (Hook, 스키마 등록)   │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     명세 로드/파싱     │
│    (노드→심볼 변환)    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     포트 연결 설정     │
│   (심볼 간 링크 생성)   │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     LoadHook 실행    │
│     (노드 활성화)      │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│    초기화 워크플로우    │
│   (init 포트 실행)    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     워크플로우 실행     │
│    (프로세스, 패킷)    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│    UnloadHook 실행   │
│    (노드 비활성화)     │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│     워크플로우 종료     │
│    (term 포트 실행)   │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│      리소스 정리       │
│   (메모리, 연결 해제)   │
└─────────────────────┘
```
## 런타임 생성 및 설정
```
Runtime 생성
  ↓
훅 등록 (LoadHook, UnloadHook)
  ↓
네임스페이스 설정
  ↓
환경 변수 초기화
```
1. 런타임 객체 생성
  * New(config) 메서드를 통해 런타임 객체를 생성합니다.
  * 네임스페이스, 환경 변수, 스키마 등을 설정합니다.
2. 훅 시스템 초기화
  * 심볼 생명주기 관리를 위한 LoadHook을 등록합니다.
  * 심볼 종료 시 리소스 정리를 위한 UnloadHook을 등록합니다.
    * 예: hook.AddLoadHook(symbol.LoadFunc(func(sb *symbol.Symbol) error { ... }))
3. 스키마 준비
  * 노드 유형별 코덱을 등록합니다.
  * 스키마에 의해 노드 명세가 실행 가능한 노드로 변환되도록 준비합니다.

## 명세 로드
```
Runtime.Load(ctx) 호출
  ↓
로더가 데이터베이스에서 명세 조회
  ↓
스키마의 코덱으로 명세 파싱
  ↓
노드 객체 생성
  ↓
심볼 테이블에 등록
```
1. 명세 로딩
  * 로더가 데이터베이스에서 노드 명세와 환경 변수를 조회합니다.
  * 각 명세는 고유 ID, 네임스페이스, 이름, 종류, 포트 정보 등을 포함합니다.
2. 명세 파싱
  * 스키마의 코덱을 사용해 명세를 실행 가능한 노드로 변환합니다.
    * 예: `scheme.CodecWithType(func(spec *NodeSpec) (node.Node, error) { ... })`
3. 심볼 생성 및 등록
  * 변환된 노드가 심볼로 래핑되어 심볼 테이블에 등록됩니다.
  * 네임스페이스와 이름을 기준으로 심볼을 저장하고 인덱싱합니다.

## 심볼 연결
```
Runtime.Reconcile(ctx) 호출
  ↓
심볼 테이블에 포트 연결 요청
  ↓
명세의 ports 섹션에 따라 심볼 간 링크 설정
  ↓
각 포트에 OpenHook 등록
```
1. 포트 정보 분석
  * 노드 명세의 ports 섹션을 기반으로 연결 관계를 파악합니다.
    ```
    ports:
      out:
        - name: target-node
          port: in
    ```
2. 심볼 간 링크 설정
  * SymbolTable.Link() 메서드를 통해 포트를 연결합니다.
  * 소스 노드의 출력 포트와 대상 노드의 입력 포트를 연결합니다.
3. OpenHook 등록
  * 각 포트에 OpenHook을 등록하여 프로세스 생성 시 포트 활성화를 준비합니다.
  * 포트 연결을 통해 워크플로우 그래프를 형성합니다.
  * 최종적으로 워크플로우가 시작할 때 훅이 실행되면서 초기화 작업이 이루어집니다.

## 노드 활성화
```
모든 심볼에 대해 LoadHooks.Load(symbol) 실행
  ↓
등록된 LoadHook 순차 실행
  ↓
init 포트 확인 및 초기화 워크플로우 실행
  ↓
포트 열기 및 Writer/Reader 생성
```
1. LoadHook 실행:
  * 모든 심볼에 대해 등록된 LoadHook을 순차적으로 실행합니다.
  * 노드 초기화 및 리소스 할당 작업을 수행합니다.
2. 초기화 워크플로우 실행:
  * init 포트가 있는 노드는 자동으로 초기화 워크플로우를 실행합니다.
  * 설정 로드, 외부 시스템 연결 등 초기화 작업을 수행합니다.
3. 포트 활성화:
  * 프로세스가 생성될 때 포트를 엽니다. (OpenHook 실행)
  * 포트에 Writer와 Reader를 생성하여 패킷 교환을 준비합니다.

## 워크플로우 실행
```
프로세스 생성
  ↓
포트 열기 (OpenHook 실행)
  ↓
패킷 생성 및 전송
  ↓
연결된 노드의 Reader가 패킷 수신
  ↓
패킷 처리 및 응답 생성
  ↓
응답 패킷 반환
  ↓
프로세스 종료
```
1. 프로세스 생성:
  * 워크플로우 실행을 위한 독립적인 프로세스를 생성합니다.
  * 명세에 맞게 부모-자식 관계를 형성합니다.
2. 패킷 흐름
  * 출력 포트에서 패킷을 생성하고 Writer를 통해 전송합니다.
    ```
     [노드A]               [노드B]
     출력포트 -- 패킷 전송 --> 입력포트
     입력포트 <--- 응답 ----- 출력포트
    ```
3. 패킷 처리
  * 각 노드는 입력 패킷을 처리하고 결과를 생성합니다.
  * 결과를 응답 패킷으로 반환하거나 다음 노드로 전달합니다.
4. 프로세스 종료
  * 모든 패킷 응답을 받으면 프로세스가 종료됩니다.
  * 프로세스 종료 시 할당된 리소스를 해제합니다.

## 종료
```
심볼 제거 요청
  ↓
UnloadHooks.Unload(symbol) 실행 (역순)
  ↓
term 포트 확인 및 종료 워크플로우 실행
  ↓
포트 연결 해제 (Unlink)
  ↓
리소스 정리 및 메모리 해제
```
1. UnloadHook 실행
  * 심볼 제거 시 등록된 UnloadHook을 역순으로 실행합니다.
  * 의존 관계에 맞게 리소스가 안전하게 해제되도록 합니다.
2. 종료 워크플로우 실행
  * term 포트가 있는 노드는 자동으로 종료 워크플로우를 실행합니다.
  * 외부 연결 종료, 임시 파일 삭제 등 정리 작업을 수행합니다.
3. 포트 연결 해제
  * SymbolTable.Unlink() 메서드를 통해 모든 포트 연결을 해제합니다.
  * 연결된 OpenHook을 제거하고 정리합니다.
4. 리소스 정리
  * 실행 중인 프로세스를 종료합니다.
  * 할당된 메모리, 열린 파일 디스크립터 등 모든 리소스를 해제합니다.
