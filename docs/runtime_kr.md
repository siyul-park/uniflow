# 워크플로우 초기화 및 실행 과정

이 가이드는 워크플로우의 컴파일 과정과 런타임 과정을 상세히 설명합니다. 시스템의 전체적인 구조와 아키텍처에 대한 설명은 [아키텍처 문서](./architecture_kr.md)를, 핵심 개념에 대한 자세한 설명은 [핵심 개념 문서](./key_concepts_kr.md)를 참조하기 바랍니다.

## 워크플로우 개요

워크플로우는 **노드 간 데이터 흐름을 형성하는 방향성 그래프**입니다. 워크플로우가 실행되기 위해서는 두 가지 핵심 과정이 필요합니다:

1. **컴파일 과정**: 명세 작성 → 유효성 검증 → 데이터베이스 저장
2. **런타임 과정**: 명세 로드 → 심볼 변환 → 노드 연결 → 패킷 처리 실행

각 워크플로우는 특정 **네임스페이스** 내에서 실행되며, 다른 네임스페이스의 노드와는 격리됩니다.

## 1. 핵심 용어 정리

| 용어 | 설명 |
|------|------|
| **명세(Spec)** | 노드의 정의를 담고 있는 정보입니다. JSON/YAML 형태로 표현되며 ID, 네임스페이스, 이름, 종류, 포트 정보 등을 포함합니다. |
| **노드(Node)** | 워크플로우의 기본 실행 단위입니다. 입력을 받아 처리하고 출력을 생성합니다. |
| **심볼(Symbol)** | 노드를 런타임에서 관리할 수 있도록 래핑한 객체입니다. 노드 인스턴스와 명세 정보를 함께 보유합니다. |
| **포트(Port)** | 노드 간 연결 지점입니다. 입력 포트(InPort)와 출력 포트(OutPort)로 구분됩니다. |
| **패킷(Packet)** | 노드 간 전달되는 데이터의 기본 단위입니다. 요청 패킷과 응답 패킷이 있습니다. |
| **프로세스(Process)** | 워크플로우 실행의 독립적인 단위입니다. 고유 ID와 상태를 가지며 패킷 처리의 컨텍스트를 제공합니다. |
| **런타임(Runtime)** | 워크플로우를 관리하고 실행하는 환경입니다. |
| **로더(Loader)** | 명세를 로드하고 노드로 변환하여 심볼 테이블에 등록합니다. |
| **심볼 테이블(Symbol Table)** | 심볼을 ID와 이름으로 관리하고 심볼 간 연결을 설정합니다. |
| **스키마(Scheme)** | 노드 유형별 코덱을 등록하고 명세를 노드로 변환하는 규칙을 제공합니다. |
| **훅(Hook)** | 심볼의 생명주기 및 포트 활성화 이벤트를 처리합니다. LoadHook, UnloadHook, OpenHook 등이 있습니다. |

## 2. 워크플로우 컴파일 과정

명세 작성부터 유효성 검증, 데이터베이스 저장을 통해 실행 가능한 형태로 준비하는 과정을 설명합니다. 

### 2.1 명세 작성 및 저장

```
명세 작성 (JSON/YAML)
  ↓
명세 유효성 검증
  ↓
데이터베이스에 저장
```

1. **명세 작성**
   * 노드의 ID, 네임스페이스, 이름, 종류, 포트 정보 등을 포함하는 명세를 작성합니다.
   * 예시:
     ```yaml
     id: "node-1"
     kind: "http"
     namespace: "default"
     name: "api-call"
     ports:
       out:
         - name: "node-2"
           port: "in"
     ```

2. **명세 유효성 검증**
   * 작성된 명세가 스키마에 부합하는지 검증합니다.
   * 포트 연결 정보의 일관성을 확인합니다.

3. **데이터베이스에 저장**
   * 검증된 명세는 `spec.Store.Store(ctx, spec)` 메서드를 통해 데이터베이스에 저장됩니다.
   * 저장된 명세는 이벤트를 통해 런타임에 변경 사항을 알립니다.

### 2.2 명세 변경 및 갱신

런타임이 실행된 이후에도 명세는 변경될 수 있으며, 이러한 변경 사항은 런타임에 실시간으로 반영됩니다.

1. **명세 변경 감지**
   * 런타임은 `Runtime.Watch(ctx)` 메서드를 통해 명세 변경 이벤트를 구독합니다.
   * 데이터베이스는 명세 변경 시 이벤트를 발행합니다.

2. **명세 갱신 반영**
   * 런타임은 `Runtime.Reconcile(ctx)` 메서드를 통해 변경된 명세를 감지하고 심볼 테이블을 갱신합니다.
   * 변경된 명세에 따라 새 노드를 생성하거나 기존 노드를 업데이트하고 연결을 재구성합니다.

## 3. 워크플로우 런타임 과정

데이터베이스에 저장된 명세를 로드하여 실행 가능한 심볼로 변환하고, 노드 간 연결을 구성한 후 패킷 기반 데이터 처리 흐름을 실행하는 전체 과정을 설명합니다.

### 3.1 런타임 초기화 및 설정

```
Runtime 객체 생성 (New)
  ↓
스키마 초기화 (코덱 등록)
  ↓
훅 시스템 설정 (LoadHook, UnloadHook)
  ↓
환경 변수 및 네임스페이스 설정
```

1. **런타임 객체 생성**
   * `Runtime.New(config)` 메서드를 통해 런타임 객체를 생성합니다.
   * 심볼 테이블과 로더를 초기화합니다.

2. **스키마 초기화**
   * 노드 유형별 코덱을 등록합니다.
   * 예: `scheme.AddCodec(kind, scheme.CodecWithType(func(spec *NodeSpec) (node.Node, error) { ... }))`

3. **훅 시스템 설정**
   * 심볼 생명주기 관리를 위한 훅을 등록합니다.
   * 예: `hook.AddLoadHook(symbol.LoadFunc(func(sb *symbol.Symbol) error { ... }))`
   * 예: `hook.AddUnloadHook(symbol.UnloadFunc(func(sb *symbol.Symbol) error { ... }))`

4. **환경 변수 및 네임스페이스 설정**
   * 런타임의 실행 환경과 컨텍스트를 구성합니다.
   * 명세를 로드할 네임스페이스를 지정합니다.

### 3.2 명세 로드 및 심볼 변환

```
Runtime.Load(ctx) 호출
  ↓
로더가 데이터베이스에서 명세 조회
  ↓
스키마의 코덱으로 명세를 노드로 변환
  ↓
노드를 심볼로 래핑
  ↓
심볼 테이블에 등록
```

1. **명세 로드**
   * `Runtime.Load(ctx)` 메서드를 호출하여 로딩 프로세스를 시작합니다.
   * 로더는 데이터베이스에서 명세를 조회합니다.
   * 환경 변수와 값도 함께 로드됩니다.

2. **명세 변환**
   * 스키마의 코덱을 사용해 명세를 실행 가능한 노드로 변환합니다.
   * 예: `scheme.CodecWithType(func(spec *NodeSpec) (node.Node, error) { ... })`

3. **심볼 생성 및 등록**
   * 변환된 노드를 심볼로 래핑합니다: `symbol := &Symbol{Spec: spec, Node: node}`
   * 심볼 테이블에 등록합니다: `symbolTable.Insert(symbol)`
   * 네임스페이스와 이름을 기준으로 심볼을 인덱싱합니다.

### 3.3 심볼 간 연결 설정

```
Runtime.Reconcile(ctx) 호출
  ↓
명세의 ports 정보 분석
  ↓
심볼 테이블에서 대상 심볼 조회
  ↓
출력 포트와 입력 포트 연결 (Link)
  ↓
각 포트에 OpenHook 등록
```

1. **포트 정보 분석**
   * 노드 명세의 ports 섹션을 기반으로 연결 관계를 파악합니다.
   * 예시:
     ```yaml
     ports:
       out:
         - name: "target-node"
           port: "in"
     ```

2. **포트 연결 설정**
   * 심볼 테이블의 `links` 메서드를 통해 포트를 연결합니다.
   * 소스 노드의 출력 포트(`Out`)와 대상 노드의 입력 포트(`In`)를 연결합니다.
   * 예: `sourcePort.Link(targetPort)`

3. **OpenHook 등록**
   * 각 포트에 OpenHook을 등록하여 프로세스 생성 시 포트 활성화를 준비합니다.
   * 예: `port.AddOpenHook(OpenHookFunc(func(proc *Process) { ... }))`
   * 이를 통해 포트가 열릴 때 Writer/Reader가 생성되고 패킷 처리가 준비됩니다.

### 3.4 노드 활성화 및 초기화

```
LoadHooks.Load(symbol) 실행
  ↓
init 포트 있는 심볼 확인
  ↓
초기화 워크플로우 실행 (init 포트)
  ↓
노드 리소스 할당 및 초기화
```

1. **LoadHook 실행**
   * 모든 심볼에 대해 등록된 LoadHook을 순차적으로 실행합니다.
   * 예: `loadHooks.Load(symbol)`
   * 이 과정에서 노드의 초기화 작업이 수행됩니다.

2. **초기화 워크플로우 실행**
   * `init` 포트가 있는 노드는 자동으로 초기화 워크플로우를 실행합니다.
   * 데이터베이스 연결 설정, 외부 시스템 연결 등 초기화 작업이 수행됩니다.
   * 예: `exec(symbol, "init")`

3. **포트 활성화 준비**
   * 각 포트는 프로세스가 생성될 때 열리도록 준비됩니다.
   * OpenHook이 등록되어 있어 프로세스 생성 시 자동으로 포트가 활성화됩니다.

### 3.5 워크플로우 실행 및 패킷 처리

```
프로세스 생성 (Process.New)
  ↓
포트 열기 (OpenHook 실행)
  ↓
입력 패킷 생성 및 전송 (FIFO)
  ↓
연결된 노드의 Reader가 패킷 수신
  ↓
노드가 패킷 처리 및 응답 생성
  ↓
응답 패킷 반환 (FIFO)
  ↓
모든 응답 수신 후 프로세스 종료
```

1. **프로세스 생성**
   * 워크플로우 실행을 위한 독립적인 프로세스를 생성합니다.
   * 예: `process := process.New()`
   * 부모-자식 관계가 필요한 경우 `process.Fork()`를 통해 생성합니다.

2. **패킷 흐름 (FIFO 처리)**
   * 패킷은 선입선출(FIFO) 방식으로 처리됩니다.
   * 출력 포트는 Writer를 통해 패킷을 전송하고, 입력 포트는 Reader를 통해 패킷을 수신합니다.
   * 패킷 전송 및 응답은 다음과 같이 이루어집니다:
     ```
     [노드A]                       [노드B]
     출력포트 ----> 요청 패킷 -----> 입력포트 
     Writer  <---- 응답 패킷 <----- Reader
     ```
   * 패킷은 항상 전송된 순서대로 처리되고 응답됩니다.

3. **패킷 처리**
   * 각 노드는 입력 패킷을 처리하고 결과를 생성합니다.
   * OneToOne, OneToMany, ManyToOne 등 다양한 패턴으로 패킷을 처리할 수 있습니다.
   * 처리 결과는 응답 패킷으로 원래의 요청 경로를 통해 반환됩니다.

4. **프로세스 종료**
   * 모든 패킷 응답을 받으면 프로세스가 종료됩니다: `process.Exit(nil)`
   * 프로세스 종료 시 할당된 리소스가 자동으로 해제됩니다.
   * 종료 시 등록된 ExitHook이 실행됩니다.

### 3.6 워크플로우 비활성화 및 정리

```
심볼 제거 요청 (Table.Free)
  ↓
term 포트 있는 심볼 확인
  ↓
종료 워크플로우 실행 (term 포트)
  ↓
UnloadHooks.Unload(symbol) 실행 (역순)
  ↓
포트 연결 해제 (Unlink)
  ↓
리소스 정리 및 메모리 해제
```

1. **심볼 제거 요청**
   * 심볼 테이블에서 심볼 제거를 요청합니다: `symbolTable.Free(symbolID)`
   * 이 과정에서 심볼의 종료 절차가 시작됩니다.

2. **종료 워크플로우 실행**
   * `term` 포트가 있는 노드는 자동으로 종료 워크플로우를 실행합니다.
   * 외부 연결 종료, 임시 파일 삭제 등 정리 작업이 수행됩니다.
   * 예: `exec(symbol, "term")`

3. **UnloadHook 실행**
   * 등록된 UnloadHook을 역순으로 실행합니다: `unloadHooks.Unload(symbol)`
   * 이를 통해 의존 관계에 맞게 리소스가 안전하게 해제됩니다.

4. **포트 연결 해제 및 리소스 정리**
   * 모든 포트 연결을 해제합니다: `symbolTable.unlinks(symbol)`
   * 연결된 OpenHook을 제거하고 정리합니다.
   * 실행 중인 프로세스를 종료하고 할당된 메모리와 리소스를 해제합니다.
   * 심볼과 관련된 모든 데이터를 정리합니다: `symbol.Close()` 